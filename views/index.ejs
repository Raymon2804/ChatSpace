<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mini whatsapp</title>
    <link rel="stylesheet" href="style.css"/>
</head>
<body>

    <h3>All chats</h3>

    <form action="/chat/new">
        <button>new chat</button>
    </form>

    <br>

    <% for(let chat of chats){ %>
        <div class="chat">

            <!-- CHAT HEADER -->
            <div class="chat-header">
                <span class="from"><%= chat.from %></span>
                <span class="arrow">â†’</span>
                <span class="to"><%= chat.to %></span>
            </div>

            <!-- MESSAGE -->
            <div class="msg">
                <p><%= chat.msg %></p>

                <form method="GET" action="/chat/<%=chat._id%>/edit">
                    <button>Edit</button>
                </form>

                <br><br>

                <form method="POST" action="/chat/<%=chat._id%>?_method=DELETE">
                    <button>Delete</button>
                </form>
            </div>

            <hr>

            <!-- TIMESTAMP -->
            <small>
                <%= chat.created_at.toString().split(" ")[4] %><br>
                <%= chat.created_at.toString().split(" ").slice(0,4).join(" ") %>
            </small>

        </div>
        <br><br>
    <% } %>

    <!-- LIVE SOCKET CHAT -->
<div id="messages">
    <% chats.forEach(chat => { %>
        <p><strong><%= chat.from %></strong>: <%= chat.msg %></p>
    <% }) %>
</div>

<input id="username" type="text" placeholder="Your name">
<input id="msg" type="text" placeholder="Type a message">
<button onclick="sendMessage()">Send</button>

<script src="/socket.io/socket.io.js"></script>

<script>
    const socket = io();

    function sendMessage() {
        let username = document.getElementById("username").value;
        let message = document.getElementById("msg").value;

        if (!username || !message) return;

        socket.emit("chatMessage", {
            from: username,
            msg: message
        });

        document.getElementById("msg").value = "";
    }

    socket.on("chatMessage", (data) => {
        let box = document.createElement("p");
        box.innerHTML = `<strong>${data.from}</strong>: ${data.msg}`;
        document.getElementById("messages").appendChild(box);
    });
</script>

</body>
</html>
